<!DOCTYPE html>
<html lang="en">
	<head>

		<title>Editor (alpha 0.1.6)</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/joystick.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">
		<link rel="stylesheet" href="/css/jcrop.css">

		<script src="/js/watch.js"></script>
		<script src="/js/Objectid.js"></script>
		<script src="/js/jquery.min.js"></script> 
		<script src="/js/system.min.js"></script>
		<script src="/js/signals.min.js"></script>
		<script src="/js/inflate.min.js"></script>
		<script src="/js/zangodb.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/validator.min.js"></script>
		<script src="/js/hold-event.min.js"></script>
		<script src="/js/jcrop.js"></script>

		<style>

			body {
				margin: 0px;
				font-size: 13px;
				font-family: sans-serif;
				background-repeat: repeat;
				background-image: url("https://i.imgur.com/rnZZU0i.png") !important;
				overflow: hidden;
			}

			#loading-bar {
				width:100%;
				height:100%;
				top:0; left:0;
				position:fixed;
				display:flex;
				align-items:center;
				justify-content:center;
			}

			.middle > * {
				top:0; 
				left:0;
				right:0;
				bottom:0;
				margin:auto;
				position:absolute;
			}

			#joystick1 {
				right: calc(40px + 370px);
			}
			
			#jumpButton {
				right: calc(105px + 370px);
			}

			.btn-matcap,
			.btn-terrain {
				padding:0;
				float:left;
				width:55px;
				height:55px;
				border:1px solid;
				border-radius:4px;
				margin-right:4px;
				margin-bottom:4px;
				display:inline-block;
			}

			.btn-matcap + .btn-matcap,
			.btn-terrain + .btn-terrain {
				margin-right:4px;
			}

		</style>
	</head>

	<body ontouchstart="">

		<script src="/editor/js/TabUI.js"></script>

		<script>
			const debugMode = true;
			const Signal = signals.Signal;
			const RAD2DEG = 57.29577951308232;
			const DEG2RAD = 0.017453292519943295;
			document.body.appendChild( createSidePanel() );
		</script>

		<script src="/editor/js/three.js"></script>
		<script src="/editor/js/MeshWalk.js"></script>
		<script src="/editor/js/UVsDebug.js"></script>
		<script src="/editor/js/FBXLoader.js"></script>
		<script src="/editor/js/VirtualInput.js"></script>
		<script src="/editor/js/KeyboardState.js"></script>
		<script src="/editor/js/EditorControls.js"></script>
		<script src="/editor/js/camera-controls.js"></script>
		<script src="/editor/js/SubdivisionModifier.js"></script>
		<script src="/editor/js/three-pathfinding.umd.js"></script>

		<script src="/threejs/r96/examples/js/loaders/GLTFLoader.js"></script>
		<script src="/threejs/r96/examples/js/exporters/GLTFExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/STLExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/OBJExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/ColladaExporter.js"></script>

	<!-- Water.js -->

		<script src="/editor/js/Ocean_fft.js"></script>
		<script src="/editor/js/MirrorRenderer.js"></script>
		<script src="/editor/js/WaterMaterial.js"></script>

	<!-- Engine.js -->

		<script src="/editor/core/helpers.js"></script>
		<script src="/editor/core/keyboard.js"></script>
		<script src="/editor/core/enviroment.js"></script>
		<script src="/editor/core/localPlayer.js"></script>
		<script src="/editor/core/cameraControls.js"></script>
		<script src="/editor/core/keyboardState.js"></script>
		<script src="/editor/core/keyInputControls.js"></script>
		<script src="/editor/core/joystickControls.js"></script>

	<!-- Editor.js -->

		<script src="/editor/src/EntityManager.js"></script>
		<script src="/editor/src/MaterialManager.js"></script>
		<script src="/editor/src/TexturesManager.js"></script>
		<script src="/editor/src/UndoArray.js"></script>
		<script src="/editor/src/editor-meta.js"></script>
		<script src="/editor/src/editor-tab-ui.js"></script>
		<script src="/editor/src/geometry-tab-ui.js"></script>
		<script src="/editor/src/material-tab-ui.js"></script>
		<script src="/editor/src/textures-tab-ui.js"></script>
		<script src="/editor/src/skydome-tab-ui.js"></script>
		<script src="/editor/src/database-tab-ui.js"></script>
		<script src="/editor/src/watchers-call-ui.js"></script>
		<script src="/editor/src/entities-helpers.js"></script>
		<script src="/editor/src/TextureEditor.js"></script>
		<script src="/editor/src/MaterialEditor.js"></script>
		<script src="/editor/src/Object3DEditor.js"></script>
		<script src="/editor/src/RigidObjects.js"></script>
		<script src="/editor/src/editor-droplists.js"></script>
		<script src="/editor/src/edges-helper.js"></script>
		<script src="/editor/src/octree-helpers.js"></script>
		<script src="/editor/src/geometry-buttons.js"></script>
		<script src="/editor/src/geometry-inputs.js"></script>
		<script src="/editor/src/editor-buttons.js"></script>
		<script src="/editor/src/rigid-objects-buttons.js"></script>
		<script src="/editor/src/editor-key-inputs.js"></script>
		<script src="/editor/src/editor-mouse-inputs.js"></script>
		<script src="/editor/src/editor-manager.js"></script>
		<script src="/editor/src/editor-systems.js"></script>
		<script src="/editor/src/material-droplists.js"></script>
		<script src="/editor/src/material-manager.js"></script>
		<script src="/editor/src/material-buttons.js"></script>
		<script src="/editor/src/material-key-inputs.js"></script>
		<script src="/editor/src/material-mouse-inputs.js"></script>
		<script src="/editor/src/texture-droplists.js"></script>
		<script src="/editor/src/texture-manager.js"></script>
		<script src="/editor/src/texture-buttons.js"></script>
		<script src="/editor/src/texture-key-inputs.js"></script>
		<script src="/editor/src/texture-mouse-inputs.js"></script>
		<script src="/editor/src/texture-viewer.js"></script>
		<script src="/editor/src/editor-center-helper.js"></script>
		<script src="/editor/src/Water.js"></script>
		<script src="/editor/src/Skydome.js"></script>
		<script src="/editor/src/skydome-droplist.js"></script>
		<script src="/editor/src/background-droplist.js"></script>
		<script src="/editor/src/skydome-buttons.js"></script>

		<script>

		//	imgurdB.js

			const imgurdB = new zango.Db( "imgur", {

				wood:      ["id"],
				rock:      ["id"],
				floor:     ["id"],
				glass:     ["id"],
				metal:     ["id"],
				plant:     ["id"],
				paster:    ["id"],
				matcap:    ["id"],
				bricks:    ["id"],
				fabric:    ["id"],
				roofing:   ["id"],
				terrain:   ["id"],
				concrete:  ["id"],
				sandstone: ["id"],

			});

			imgurdB.open(function(err, database){
				if (err) console.error(err);
			}).then( function(){

				debugMode && console.log( 
					"Database " + imgurdB.name 
					+ " (v" + imgurdB.version 
					+ ") ready for use."
				);

			}).catch(function(err){
				console.error(err);
			});

		</script>

		<script>

		//	Imgur Images Tab.

			TabUI.add( "Images", "images-tab" );
			TabUI.append( "Images" );

			(function( tab ){

			//	Images Collection droplist.
			//	var tab = TabUI.Images.tab;

				var row = document.createElement("h3");
				row.textContent = "Collection:";
				row.style.cssText = "height:30px;"

				var select = document.createElement("select");
				select.id = "imgur-collection-droplist";
				select.style.cssText = "width:150px;color:#000;float:right;";
				select.style.cssText += "border:1px solid;border-radius:4px;padding:2px 4px 4px 4px;";
				select.style.cssText += "font-size:20px;margin-left:10px;margin-right:15px;";

				var keys = "wood,rock,floor,glass,metal,plant,paster,matcap,bricks,fabric,roofing,terrain,concrete,sandstone";

				keys.split(",").forEach(function( name ){
					var option = document.createElement("option");
					option.text = name;
					option.value = name;
					select.appendChild( option );
				});

				row.appendChild( select );
				tab.appendChild( row );

				return select;

			})( TabUI.Images.tab );


		//	imgur-viewer-ui.js

			(function( tab ){

			//	Image viewer.
			//	var tab = TabUI.Images.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:260px;border:none;text-align:center;"; // margin-right:15px;

				var img = new Image(256,256)
				img.id = "imgur-image-viewer";
				img.src = img.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
				img.style.cssText = "width:256px;height:256px;margin:auto;background-repeat:repeat;";
				img.style.cssText += "background-image:url('https://i.imgur.com/rnZZU0i.png') !important;";

				row.appendChild( img );
				tab.appendChild( row );

			})( TabUI.Images.tab );

		//	imgur-name-input-ui.js

			(function( tab ){

			//	Images texture name input.
			//	var tab = TabUI.Images.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:30px;margin:10px 15px;";

				var prev = document.createElement("li");
				prev.id = "imgur-doc-previous";
				prev.innerHTML = "&#9668;";
				prev.style.display = "inline";
				prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");

				var next = document.createElement("li");
				next.id = "imgur-doc-next";
				next.innerHTML = "&#9658;";
				next.style.display = "inline";
				next.classList.add("btn","btn-primary","get-next-btn","pull-right");

				var input = document.createElement("input");
				input.id = "imgur-name-input";
				input.setAttribute("placeholder", "filename or _id" );
				input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:180px;margin:0px 10px 0px 10px;";
				input.style.cssText += "text-align:center;font-size:large;font-weigth:bold;background:none;";

				row.appendChild(prev);
				row.appendChild(input);
				row.appendChild(next);
				tab.appendChild( row );

			})( TabUI.Images.tab );

		//	upload-image-file-ui.js

			(function( tab ){

			//	Images upload button.
			//	var tab = TabUI.Images.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:30px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "imgur-upload-button";
				button.textContent = "Upload Texture Images";
				button.classList.add( "form-control","btn", "btn-primary","btn-white-outline","gradient-btn" );
				button.style.cssText = "width:-webkit-fill-available;float:right;height:40px;";
				button.style.cssText += "font-size:large;margin-left:15px;margin-right:15px;";

				var input = document.createElement("input");
				input.type = "file";
				input.id = "imgur-file-input";
				input.setAttribute( "multiple", "" ); // true.
				input.style.cssText = "display:none;";
				button.appendChild( input );

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Images.tab );

		//	images-cache-button.js

			(function( tab ){

			//	Images cache button.
			//	var tab = TabUI.Images.tab;

				var row = document.createElement("h3");
				row.style.cssText = "height:30px;margin-bottom:20px;"

				var button = document.createElement("div");
				button.id = "imgur-cache-button";
				button.textContent = "Cache Collection Images";
				button.classList.add( "form-control","btn", "btn-primary","btn-white-outline","gradient-btn" );
				button.style.cssText = "width:-webkit-fill-available;float:right;height:40px;";
				button.style.cssText += "font-size:large;margin-left:15px;margin-right:15px;";

				row.appendChild( button );
				tab.appendChild( row );

			})( TabUI.Images.tab );

		</script>

		<script>

		//	imgur-skip-inputs.js

			(function(db,next_doc,prev_doc,name_input,img_viewer,collection_droplist){

				var interval, index = 0, limit = 100, items = [];

				window.addEventListener( "mouseup", function (){ clearTimeout( interval ); }); // important!

			//	Collection droplist.

				watch(collection_droplist, "onchange",function(prop, event, value){

					try { 

						collection = db.collection( value ); // debugMode && console.log( "collection:", collection ); 

					} catch(err){

						return callWatchers(collection_droplist, "onchange", "change", collection_droplist.value = "matcap");
					}

				//	Reset.

					index = 0; items = [];

				//	Get names.

					db.collection( value ).find().skip(index).limit(limit).toArray().then(function(docs){ 

						items = docs.map(function(doc){
							return { name:doc.name, link:doc.link, id:doc.id, _id:doc._id } 
						}); name_input.value = items[index].name || items[index]._id; 

						debugMode && console.log( items );

					}).catch(function(err){ console.error(err); });

				});

				watch( next_doc, "onclick", function( prop, event, value ){
					debugMode && console.log({item:next_doc,event:event});
				});

				watch( prev_doc, "onclick", function( prop, event, value ){
					debugMode && console.log({item:prev_doc,event:event});
				});

				watch( name_input, "onchange", function( prop, event, value ){ 
					debugMode && console.log({item:name_input,event:event});
				});

			//	on key change.

				name_input.addEventListener( "change", function(){
					this.blur(); callWatchers( this, "onchange", "change", index );
				});

			//	on mouse down.

				next_doc.addEventListener( "mousedown", function(){
					clearTimeout( interval ); // important!
					interval = setTimeout(function increase(){
						var max = items.length - 1;
						var i = THREE.Math.clamp(++index, 0, max);
						name_input.value = items[i].name || items[i]._id;
						interval = setTimeout(increase, 100);
					}, 500);
				});

				prev_doc.addEventListener( "mousedown", function(){
					clearTimeout( interval ); // important!
					interval = setTimeout(function decrease(){
						var max = items.length - 1;
						var i = THREE.Math.clamp(--index, 0, max);
						name_input.value = items[i].name || items[i]._id;
						interval = setTimeout(decrease, 100);
					}, 500);
				});

			//	on mouse click.

				next_doc.addEventListener( "click", function(){
					clearTimeout( interval ); // important!
					var max = items.length - 1;
					var i = THREE.Math.clamp(++index, 0, max);
					name_input.value = items[i].name || items[i]._id;
					interval = setTimeout(function(){
						img_viewer.src = "https://i.imgur.com/"+items[i].id+"t.jpg";
					},250);
					callWatchers( this, "onclick", "click", index ); // important!
				});

				prev_doc.addEventListener( "click", function(){
					clearTimeout( interval ); // important!
					var max = items.length - 1;
					var i = THREE.Math.clamp(--index, 0, max);
					name_input.value = items[i].name || items[i]._id;
					interval = setTimeout(function(){
						img_viewer.src = "https://i.imgur.com/"+items[i].id+"t.jpg";
					},250);
					callWatchers( this, "onclick", "click", index ); // important!
				});

				collection_droplist.addEventListener( "change", function(){
					this.blur(); callWatchers( this, "onchange", "change", this.value );
				});

				callWatchers(collection_droplist, "onchange", "change", collection_droplist.value);

			})(
				imgurdB, // db,
				TabUI.Images.tab.querySelector("li#imgur-doc-next"), // next_doc,
				TabUI.Images.tab.querySelector("li#imgur-doc-previous"), // prev_doc,
				TabUI.Images.tab.querySelector("input#imgur-name-input"), // name_input,
				TabUI.Images.tab.querySelector("img#imgur-image-viewer"), // img_viewer,
				TabUI.Images.tab.querySelector("select#imgur-collection-droplist") // collection_droplist,
			);


		</script>

		<script>

		//	imgur-upload-button.js

			(function(db,input,button,collection_droplist){

				input.addEventListener( "change", function onChange(){

					var collection = db.collection(collection_droplist.value);

					if ( !input.files.length ) return;
					debugMode && console.log( input.files );

					input.removeEventListener( "change", onChange );

					var uploads = [], promises = [], results = [];

					for (var i = 0; i < input.files.length; i++ ){
						(function(file){
							uploads.push( function(){
								return uploadTexture( file )
								.then(function( data ){
									if ( !data.error ) {
										results.push( data );
										collection.insert(data);
									}
								}).catch(function(err){
									console.error(err);
								});
							});
						})( input.files[i] );
					}

					debugMode && console.log( "uploads:", uploads );

					while ( uploads.length ){
						promises.push( uploads.shift().call() );
					}

					Promise.all(promises).then(function(){

						debugMode && console.log( "results:", results );

						if ( results.length ) {

							var success = results.map( function( data ){ 
								return {name:data.name, id:data.id}; 
							}).filter(Boolean);

							debugMode && console.log( success );
							debugMode && console.log( JSON.stringify(success) );
							console.log( "Success:", results.length, "of", 
							input.files.length, "files uploaded successfully.");

						}

					}).catch(function(err){
						console.error(err);
					}).then( function(){
						input.addEventListener( "change", onChange );
					});

					function uploadTexture(file){
					//  Returns a resolved promise with record data from imgur.com.
						debugMode && console.log("uploading", file.name, "...");
						return new Promise(function( resolve, reject ){

							var formdata = new FormData();
							formdata.append("image", file);
							formdata.append("type",  file.type);
							formdata.append("name",  file.name);

							var xhttp = new XMLHttpRequest();
							var clientid = "06217f601180652";  // slothes app.
							var endpoint = "https://api.imgur.com/3/image";
							xhttp.open("POST", endpoint, true);
							xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
							xhttp.onreadystatechange = function () {
								if (this.readyState === 4) {
									var response = "";
									if (this.status >= 200 && this.status < 300) {
										response = JSON.parse(this.responseText);
										debugMode && console.log(response.data);
										resolve(response.data); // resolve promise.
									} else {
										var err = JSON.parse(this.responseText).data.error;
										console.error( err.type, err );
										resolve( {file:file.name, error:err.type, message:err} ); // throw err;
									}
								}
							};

							xhttp.send(formdata);
							xhttp = null;
						});
					}

				});

			//	Call watchers.

				button.addEventListener( "click", function(){ 
					input.value = "";
					input.click();
					return false;
				});

			})(
				imgurdB, // db,
				TabUI.Images.tab.querySelector("input#imgur-file-input"), // input,
				TabUI.Images.tab.querySelector("div#imgur-upload-button"), // button,
				TabUI.Images.tab.querySelector("select#imgur-collection-droplist") // collection_droplist,
			);

		</script>

		<script>
/*
			(function(){

				var matcaps  = "bixnsMm,MS1GDja,pUytALG,4KwC8wH,Wiqsp9s,gXRFY3U,2tkhy7C,D64zaTR,Id8k2u4,Fx9154f,dqKYFPo,l0Lf1LN,";
					matcaps += "7bH7Ajw,IeAwKEi,VysdwUU,dWAhf12,9ufYr2S,iAWd8i1,mkGDAn5,gf3PsvD,BeHwxKA,GYBQ8Xr,9gxylAS,0p2RT39,";
					matcaps += "aHeUCko,epbmrGs,NKMFDGB,pvXMCj9,QbZ8H2v,aCAVXQb,qU0AEUM,yvwt1wj,D5UeFcC,6GZMeko,rSlm3oM,Xqg7n0A,";
					matcaps += "PzHZLHy,MEzwCJq,wgf7Vl0,GcLQiey,3xH34nj,vhdhgMe,jRTIv3l,xELCxlQ,wtJaViy,Qb0qKtc,7kq8wQ3,F6kcile,";
					matcaps += "0LRxFql,rxUXS8C,qXg0NKn,LSB7hqR,EolEkFt,gOtyiMy,YTE0R32,thsIYPF,ee6stBn,gyYhQao,QOEE3jO,0V4rQPV,";
					matcaps += "l9Tugo0,R86xHzg,IDlk0H9,tUparH7,GISkhjO,JQzRceW,WxVSuFW,4tyRlwP,aFIJ3Iu,BCqRnS4,1OcGlAa,PqIxyYE,";
					matcaps += "S7J95Cf,QPUvzXD,Stdy1eT,k0nOt5N,rWuDYYe,SGRUmyD,1Ia4Qbk,FFYLtQa,szmc38X,NJSPJlS,8HsVNJA,n3wbE5E,";
					matcaps += "88autaS,7jwTUiI,H1F3Yrv,kgV7aSY,PDFIrWw,Uun8Lpr,Oz16d2L,02gRNwL,bV94g46,eUEtBHC,e1N7JYN,bWpofvm,";
					matcaps += "uzlo3mR,YaXveL2,mw2f1lF,HkWGQb1,N9xoehs,53rWmmo,sBPySdS,1YZKblR,ywKHb7r,3UcbBN7,pWPtSJS,n1a2nB8,";
					matcaps += "lecZa2Q,e3bxY9I,Jl6XqD0";

				matcaps.split(",").forEach(function(id){
					new Promise(function( resolve, reject ){

						var endpoint = "https://api.imgur.com/3/image/"+id;
						var clientID = "06217f601180652";  // sloothes app Client-ID.

						var xhttp = new XMLHttpRequest();
						xhttp.open("GET", endpoint, true);
						xhttp.setRequestHeader("Authorization", "Client-ID " + clientID);
						xhttp.onreadystatechange = function () {
							if (this.readyState === 4) {
								var response = "";
								if (this.status >= 200 && this.status < 300) {
									response = JSON.parse(this.responseText);
									debugMode && console.log(response);
									resolve(response.data); // resolve promise.
								} else {
									var err = JSON.parse(this.responseText).data.error;
									console.error( err.type, err );
									reject( err );
								}
							}
						};

						xhttp.send();
						xhttp = null;
					}).then(function(data){
						imgurdB.collection("matcap").insert(data);
					})
				});

			})();
*/
		</script>

		<script>

			TabUI.Images.role.classList.add("active");
			TabUI.Images.tab.classList.add("in","active");

		//	scene.add(ground);
		//	mirror.visible = !mirror.visible; 
		//	ground.visible = !ground.visible; 
			groundHelper.visible = !groundHelper.visible; 


		//	Add entities.
		//	entities.add(scene);
		//	entities.add(mirror);
		//	entities.add(ground);
		//	entities.add(localPlayer);
			entities.add(groundHelper);
			entities.add(localPlayer.getObjectByName("local helper"));

			cameraControls.setLatLon(5.128, 270.675);
			localPlayer.controller.movementSpeed = 20;
			localPlayer.controller.center.set(-85,2,-2);
			localPlayer.visible = !localPlayer.visible; 

		</script>

		<script src="/editor/src/database-inputs.js"></script>
	<!-- script src="/editor/src/ViewportTab.js"></script -->
		<script src="/editor/src/playground.js"></script>

	</body>
</html>
