<!DOCTYPE html>
<html lang="en">
	<head>

		<title>Editor (alpha 0.1.6)</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/joystick.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">
		<link rel="stylesheet" href="/css/jcrop.css">

		<script src="/js/watch.js"></script>
		<script src="/js/Objectid.js"></script>
		<script src="/js/jquery.min.js"></script> 
		<script src="/js/system.min.js"></script>
		<script src="/js/signals.min.js"></script>
		<script src="/js/inflate.min.js"></script>
		<script src="/js/zangodb.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/hold-event.min.js"></script>
		<script src="/js/jcrop.js"></script>

		<style>

			body {
				margin: 0px;
				font-size: 13px;
				font-family: sans-serif;
				background-repeat: repeat;
				background-image: url("https://i.imgur.com/rnZZU0i.png") !important;
				overflow: hidden;
			}

			#loading-bar {
				width:100%;
				height:100%;
				top:0; left:0;
				position:fixed;
				display:flex;
				align-items:center;
				justify-content:center;
			}

			.middle > * {
				top:0; 
				left:0;
				right:0;
				bottom:0;
				margin:auto;
				position:absolute;
			}

			#joystick1 {
				right: calc(40px + 370px);
			}
			
			#jumpButton {
				right: calc(105px + 370px);
			}

			.btn-matcap,
			.btn-terrain {
				padding:0;
				float:left;
				width:55px;
				height:55px;
				border:1px solid;
				border-radius:4px;
				margin-right:4px;
				margin-bottom:4px;
				display:inline-block;
			}

			.btn-matcap + .btn-matcap,
			.btn-terrain + .btn-terrain {
				margin-right:4px;
			}

		</style>
	</head>

	<body ontouchstart="">

		<script src="/editor/js/TabUI.js"></script>

		<script>
			const debugMode = true;
			const Signal = signals.Signal;
			const RAD2DEG = 57.29577951308232;
			const DEG2RAD = 0.017453292519943295;
			document.body.appendChild( createSidePanel() );
		</script>

		<script src="/editor/js/three.js"></script>
		<script src="/editor/js/MeshWalk.js"></script>
		<script src="/editor/js/UVsDebug.js"></script>
		<script src="/editor/js/FBXLoader.js"></script>
		<script src="/editor/js/VirtualInput.js"></script>
		<script src="/editor/js/KeyboardState.js"></script>
		<script src="/editor/js/EditorControls.js"></script>
		<script src="/editor/js/camera-controls.js"></script>
		<script src="/editor/js/SubdivisionModifier.js"></script>
		<script src="/editor/js/three-pathfinding.umd.js"></script>

		<script src="/threejs/r96/examples/js/loaders/GLTFLoader.js"></script>
		<script src="/threejs/r96/examples/js/exporters/GLTFExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/STLExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/OBJExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/ColladaExporter.js"></script>

	<!-- Water.js -->

		<script src="/editor/js/Ocean_fft.js"></script>
		<script src="/editor/js/MirrorRenderer.js"></script>
		<script src="/editor/js/WaterMaterial.js"></script>

	<!-- Engine.js -->

		<script src="/editor/core/helpers.js"></script>
		<script src="/editor/core/keyboard.js"></script>
		<script src="/editor/core/enviroment.js"></script>
		<script src="/editor/core/localPlayer.js"></script>
		<script src="/editor/core/cameraControls.js"></script>
		<script src="/editor/core/keyboardState.js"></script>
		<script src="/editor/core/keyInputControls.js"></script>
		<script src="/editor/core/joystickControls.js"></script>

	<!-- Editor.js -->

		<script src="/editor/src/EntityManager.js"></script>
		<script src="/editor/src/MaterialManager.js"></script>
		<script src="/editor/src/TexturesManager.js"></script>
		<script src="/editor/src/UndoArray.js"></script>
		<script src="/editor/src/editor-meta.js"></script>
		<script src="/editor/src/editor-tab-ui.js"></script>
		<script src="/editor/src/geometry-tab-ui.js"></script>
		<script src="/editor/src/material-tab-ui.js"></script>
		<script src="/editor/src/textures-tab-ui.js"></script>
		<script src="/editor/src/skydome-tab-ui.js"></script>
		<script src="/editor/src/database-tab-ui.js"></script>
		<script src="/editor/src/watchers-call-ui.js"></script>
		<script src="/editor/src/entities-helpers.js"></script>
		<script src="/editor/src/TextureEditor.js"></script>
		<script src="/editor/src/MaterialEditor.js"></script>
		<script src="/editor/src/Object3DEditor.js"></script>
		<script src="/editor/src/RigidObjects.js"></script>
		<script src="/editor/src/editor-droplists.js"></script>
		<script src="/editor/src/edges-helper.js"></script>
		<script src="/editor/src/octree-helpers.js"></script>
		<script src="/editor/src/geometry-buttons.js"></script>
		<script src="/editor/src/geometry-inputs.js"></script>
		<script src="/editor/src/editor-buttons.js"></script>
		<script src="/editor/src/rigid-objects-buttons.js"></script>
		<script src="/editor/src/editor-key-inputs.js"></script>
		<script src="/editor/src/editor-mouse-inputs.js"></script>
		<script src="/editor/src/editor-manager.js"></script>
		<script src="/editor/src/editor-systems.js"></script>
		<script src="/editor/src/material-droplists.js"></script>
		<script src="/editor/src/material-manager.js"></script>
		<script src="/editor/src/material-buttons.js"></script>
		<script src="/editor/src/material-key-inputs.js"></script>
		<script src="/editor/src/material-mouse-inputs.js"></script>
		<script src="/editor/src/texture-droplists.js"></script>
		<script src="/editor/src/texture-manager.js"></script>
		<script src="/editor/src/texture-buttons.js"></script>
		<script src="/editor/src/texture-key-inputs.js"></script>
		<script src="/editor/src/texture-mouse-inputs.js"></script>
		<script src="/editor/src/texture-viewer.js"></script>
		<script src="/editor/src/editor-center-helper.js"></script>
		<script src="/editor/src/Water.js"></script>
		<script src="/editor/src/Skydome.js"></script>
		<script src="/editor/src/skydome-droplist.js"></script>
		<script src="/editor/src/background-droplist.js"></script>
		<script src="/editor/src/skydome-buttons.js"></script>
		<script src="/editor/src/database-inputs.js"></script>

		<script>

		//	database-skip-input.js

			(function( db,skip_input,key_droplist,collection_droplist ){

				var max = 0, skip = 0;
				var collection = db.collection(collection_droplist.value);

				function count(collection){
				//	returns promise: count(col).then(function(result){...})
					var k = 0; return collection.find()
						.forEach( function(doc){ ++k; })
						.catch(function(err){console.error(err);})
						.then(function(){ return k; });
				}

				function get_doc(skip){

					collection.find().skip(skip).limit(1).toArray( function(err,docs){ 
						if (err) throw err; if ( !docs.length ) throw "None doc found!";
					}).then(function(results){ return results[0]; }).then(function(doc){

						debugMode && console.log(doc);
						return doc; // important!

					}).catch(function(err){
						debugMode && console.error(err);
					});
				}

			//	Update collection.
				watch( collection_droplist, "onchange", function( prop, event, value ){
					collection = db.collection(value); // debugMode && console.log( "collection:", collection ); 
				});

			//	Get skip.
				watch( skip_input, "onchange", function(prop, event, value){

					max = 0; skip = 0; // reset.

				//	skip = parseInt(value); if ( isNaN(skip) ) skip_input = skip = 0;

					count(collection).then(function(k){ max = k; }).then(function(){ 

						value = THREE.Math.clamp(value, 0, max - 1);
						if ( isNaN(value) ) value = 0; return( value );

					}).then(function(value){ 

						skip_input.value = skip = value; 

					//	get doc.
						return collection.find().skip(skip)
						.limit(1).toArray( function(err,docs){ 
							if (err) throw err;
						}).then(function(docs){ 
							return docs[0]; 
						});

					}).then(function(doc){
						debugMode && console.log(doc);

						if ( !doc ) throw "none document found!"

					//	remove old key options.
						while (key_droplist.options.length) {
							key_droplist.options.remove(0);
							if (!key_droplist.options.length) return doc;
						}

					}).then(function(doc){

					//	create new key options.
						Object.keys(doc).forEach(function( key ){
							var option = document.createElement("option");
							option.text = option.value = key;
							key_droplist.appendChild( option );
						});

						callWatchers(key_droplist, "onchange", "change", key_droplist.value); 

					}).catch(function(err){
						console.error(err);
					});

				});

			})( 
				metadB, // db,
				TabUI.Database.tab.querySelector("input#doc-skip-input"),      // skip_input,
				TabUI.Database.tab.querySelector("select#doc-keys-droplist"),  // key_droplist,
				TabUI.Database.tab.querySelector("select#collection-droplist") // collection_droplist,
			);

		</script>

		<script>

		//	database-buttons.js

		//	todo: update-meta-doc-button.js

		//	update-meta-value-button.js

			(function( 
				db,skip_input,value_input,update_value,
				key_droplist,collection_droplist,
				textures_entities,material_entities,entities 
			){

				var interval, doc;
				var key = key_droplist.value;
				var skip = parseInt(skip_input.value); 
				if ( isNaN(skip) ) skip_input.value = skip = 0;
				var collection = db.collection(collection_droplist.value);

				function get_doc(skip){

					collection.find().skip(skip).limit(1).toArray( function(err,docs){ 
						if (err) throw err; if ( !docs.length ) throw "None doc found!";
					}).then(function(results){ return results[0]; }).then(function(result){

						if ( !result ) 
							throw "None doc found!";
						else
							doc = result; // important!

						debugMode && console.log(doc);

					}).catch(function(err){

						doc = undefined; // important!
						debugMode && console.error(err);

					}).then(function(){
						return doc; // always return doc.
					});
				}

				watch( collection_droplist, "onchange", function( prop, event, value ){ 
					collection = db.collection( value ); 
				});

				watch( key_droplist, "onchange", function( prop, event, value ){ key = value; });

				watch( skip_input, "onchange", function( prop, event, value ){ 
					skip = parseInt(value); if ( isNaN(skip) ) skip_input.value = skip = 0;
				});

				watch( value_input, "onchange", function( prop, event, value ){ 
					debugMode && console.log({item:value_input,property:prop,event:event,value:value});
				});

			//	database-update-value-button.js

				watch( update_value, "onclick", function( prop, event, doc ){ 
					debugMode && console.log({item:update_value,property:prop,event:event,doc:doc});

					function updateValue( id, key, value ){

						var selector = {_id:id};
						var modifier = {$set: { [key]:value } };

						collection.update( selector, modifier, function(err){ 

							if (err) throw err; 

							collection.findOne(selector).then(function(result){ 

							//	Fatal Error.
								if ( !result ) 
									throw "FatalError: document did not found!";

							//	update doc.
								doc = result;

							//	return value.
								return result[key]; 

							}).then(function(value){

							//	Success.
								value_input.value = value; // update input.
								console.log( "Success:", key, "value updated:", value );

							}).catch(function(err){
								console.error(err);
								value_input.value = doc[ key ];
							});
							
						}).catch(function(err){
							console.error(err);
							value_input.value = doc[ key ];
							console.log("Failed:", key, "value did not updated!")
						});
					}

					if ( collection.name === "object" ) return (function(){

						switch ( key ){
						//	string.
							case "name":
								(function( value ){
									if ( !value ) return value_input.value = doc[key];
									return updateValue( doc._id, key, value_input.value );
								})( value_input.value );
							break;
						//	number.
							case "layer":
								(function( value ){
									if ( isNaN(value) ) {
										return value_input.value = doc[key];
									}
									value = THREE.Math.clamp( value, 0, 31);
									return updateValue( doc._id, key, value );
								})( parseInt(value_input.value) );
							break;
						//	boolean.
							case "visible":
								(function( value ){
									if ( value === 0 ) value = false;
									else if ( value === 1 ) value = true;
									else if ( value.toLowerCase() === "true" ) value = true;
									else if ( value.toLowerCase() === "false" ) value = false;
									else return value_input.value = doc[key];
									return updateValue( doc._id, key, value );
								})( value_input.value );
							break;
							default:
								value_input.value = doc[key];
							break;
						}

					})();

					if ( collection.name === "geometries" ) return (function(){


					})();

					if ( collection.name === "materials" ) return (function(){



					})();

					if ( collection.name === "textures" ) return (function(){



					})();

					if ( collection.name === "images" ) return (function(){



					})();

				});

			//	Call watchers.

				value_input.addEventListener( "change", function(){
					callWatchers( this, "onchange", "change", this.value );
				})

				update_value.addEventListener( "click", function(){ 
					clearTimeout( interval );
					interval = setTimeout(function(button){
						callWatchers( button, "onclick", "click", get_doc(skip) );
					}, 250, this); 
				});

			})( 
				metadB, // db, 
				TabUI.Database.tab.querySelector("input#doc-skip-input"),        // skip_input,
				TabUI.Database.tab.querySelector("input#doc-value-input"),       // value_input,
				TabUI.Database.tab.querySelector("div#update-value-button"),     // update_value,
				TabUI.Database.tab.querySelector("select#doc-keys-droplist"),    // key_droplist,
				TabUI.Database.tab.querySelector("select#collection-droplist"),  // collection_droplist,
				textures_entities, material_entities, entities
			);

		</script>

		<script>

		//	load-meta-doc-button.js

			(function( db,load_button,skip_input,collection_droplist,textures_entities,material_entities,entities ){

				var interval;
				var skip = skip_input.value;
				var collection = db.collection(collection_droplist.value);

				watch( collection_droplist, "onchange", function(prop, event, value){ 
					collection = db.collection(value); 
				});

				watch( skip_input, "onchange", function( prop, event, value ){ skip = parseInt(value); });

			//	load from database.

				watch( load_button, "onclick", function( prop, event, value ){ 
					debugMode && console.log({item:load_button,property:prop,event:event,value:value});

					var skip = parseInt(skip_input.value); if ( isNaN(skip) ) return;
					var collection = db.collection(collection_droplist.value); if ( !collection ) return; 

					if ( skip !== undefined && collection.name === "objects" ) {

						return collection.find().skip(skip).limit(1).toArray()
						.then(function(docs){ return docs[0]; }).then(function(doc){

						//	Create json.

							var json = {};
						//	json.shapes = [];
							json.images = [];
							json.textures = [];
							json.materials = [];
							json.geometries = [];
							json.metadata = {
								version: 4.5, type: "Object",
								generator: "Object3D.toJSON"
							}

							json.object = doc; // important!

						//	Collect geometry, material.

							return Promise.all([

								db.collection("geometries")
								.findOne({uuid:doc.geometry})
								.then(function(doc){
									json.geometries.push(doc); 
									return json.geometries; 
								}).catch(function(err){
									console.error(err);
								}),

								db.collection("materials")
								.findOne({uuid:doc.material})
								.then(function(doc){
									json.materials.push(doc); 
									return json.materials; 
								}).catch(function(err){
									console.error(err);
								}),

							]).then(function([geometries, materials]){
								debugMode && console.log(geometries, materials);

							//	Collect textures, images.

								var texture_uuids = [];
								materials.forEach(function(material){
									if (material.map) texture_uuids.push(material.map);
									if (material.aoMap) texture_uuids.push(material.aoMap);
									if (material.envMap) texture_uuids.push(material.envMap);
									if (material.lightMap) texture_uuids.push(material.lightMap);
									if (material.bumpMap) texture_uuids.push(material.bumpMap);
									if (material.alphaMap) texture_uuids.push(material.alphaMap);
									if (material.normalMap) mtexture_uuids.push(material.normalMap);
									if (material.specularMap) texture_uuids.push(material.specularMap);
									if (material.gradiendMap) texture_uuids.push(material.gradiendMap);
									if (material.emissiveMap) texture_uuids.push(material.emissiveMap);
									if (material.metalnessMap) texture_uuids.push(material.metalnessMap);
									if (material.roughnessMap) texture_uuids.push(material.roughnessMap);
									if (material.displacementMap) texture_uuids.push(material.displacementMap);
								}); 

								debugMode && console.log("texture_uuids:", texture_uuids);

								var promises = [];

								texture_uuids.forEach(function(uuid){ 
									promises.push(
										(function(){

											return db.collection("textures")
											.findOne({uuid:uuid})
											.then(function(doc){

												if (!doc) return;
												doc && json.textures.push(doc); 
												return doc; 

											}).then(function(doc){
												if (!doc) return;

												return db.collection("images")
												.findOne({uuid:doc.image})
												.then(function(doc){
													doc && json.images.push(doc); 
												}).catch(function(err){
													console.error(err);
												});

											}).catch(function(err){
												console.error(err);
											});

										})()
									);
								});

								debugMode && console.log("promises:", promises);

								if (!promises.length ) return json;

								return Promise.all(promises)
								.catch(function(err){
									console.error(err);
								}).then(function(){ return json; });

							}).then(function(json){
								debugMode && console.log("json:", json);

							//	Parse json.

								var loader = new THREE.ObjectLoader();
								return loader.parse( json );

							}).then(function(mesh){

							//	Replace uuids.

								mesh.geometry.uuid = THREE.Math.generateUUID();
								mesh.material.uuid = THREE.Math.generateUUID();

								var material = mesh.material;
								if (material.map) mesh.material.map.uuid = THREE.Math.generateUUID();
								if (material.aoMap) mesh.material.aoMap.uuid = THREE.Math.generateUUID();
								if (material.envMap) mesh.material.envMap.uuid = THREE.Math.generateUUID();
								if (material.lightMap) mesh.material.lightMap.uuid = THREE.Math.generateUUID();
								if (material.bumpMap) mesh.material.bumpMap.uuid = THREE.Math.generateUUID();
								if (material.alphaMap) mesh.material.alphaMap.uuid = THREE.Math.generateUUID();
								if (material.normalMap) mesh.material.normalMap.uuid = THREE.Math.generateUUID();
								if (material.specularMap) mesh.material.specularMap.uuid = THREE.Math.generateUUID();
								if (material.gradiendMap) mesh.material.gradiendMap.uuid = THREE.Math.generateUUID();
								if (material.emissiveMap) mesh.material.emissiveMap.uuid = THREE.Math.generateUUID();
								if (material.metalnessMap) mesh.material.metalnessMap.uuid = THREE.Math.generateUUID();
								if (material.roughnessMap) mesh.material.roughnessMap.uuid = THREE.Math.generateUUID();
								if (material.displacementMap) mesh.material.displacementMap.uuid = THREE.Math.generateUUID();

								return mesh;

							}).then(function(mesh){
								debugMode && console.log("mesh:", mesh);

							//	Add to scene.
								scene.add(mesh);

							//	Add to entities managers.
								entities.add(mesh);
								material_entities.add(mesh.material);

								var material = mesh.material;
								if (material.map) textures_entities.add( mesh.material.map );
								if (material.aoMap) textures_entities.add( mesh.material.aoMap );
								if (material.envMap) textures_entities.add( mesh.material.envMap );
								if (material.lightMap) textures_entities.add( mesh.material.lightMap );
								if (material.bumpMap) textures_entities.add( mesh.material.bumpMap );
								if (material.alphaMap) textures_entities.add( mesh.material.alphaMap );
								if (material.normalMap) textures_entities.add( mesh.material.normalMap );
								if (material.specularMap) textures_entities.add( mesh.material.specularMap );
								if (material.gradiendMap) textures_entities.add( mesh.material.gradiendMap );
								if (material.emissiveMap) textures_entities.add( mesh.material.emissiveMap );
								if (material.metalnessMap) textures_entities.add( mesh.material.metalnessMap );
								if (material.roughnessMap) textures_entities.add( mesh.material.roughnessMap );
								if (material.displacementMap) textures_entities.add( mesh.material.displacementMap );


							}).catch(function(err){
								console.error(err);
							});

						}).catch(function(err){
							console.error(err);
						});
					}

				});

			//	Call watchers.

				skip_input.addEventListener( "change", function(){
					callWatchers( this, "onchange", "change", this.value );
				})

				load_button.addEventListener( "click", function(){ 
					clearTimeout( interval );
					interval = setTimeout(function(button){
						callWatchers( button, "onclick", "click" );
					}, 250, this); 
				});

			})( 
				metadB, // db, 
				TabUI.Database.tab.querySelector("div#doc-load-button"),         // load_button,
				TabUI.Database.tab.querySelector("input#doc-skip-input"),        // skip_input,
				TabUI.Database.tab.querySelector("select#collection-droplist"),  // collection_droplist,
				textures_entities, material_entities, entities
			);

		</script>

		<script>

			TabUI.Database.role.classList.add("active");
			TabUI.Database.tab.classList.add("in","active");

		//	scene.add(ground);
		//	mirror.visible = !mirror.visible; 
		//	ground.visible = !ground.visible; 
			groundHelper.visible = !groundHelper.visible; 


		//	Add entities.
		//	entities.add(scene);
		//	entities.add(mirror);
		//	entities.add(ground);
		//	entities.add(localPlayer);
			entities.add(groundHelper);
			entities.add(localPlayer.getObjectByName("local helper"));

			cameraControls.setLatLon(5.128, 270.675);
			localPlayer.controller.movementSpeed = 20;
			localPlayer.controller.center.set(-85,2,-2);

		</script>

		<script>

		//	deck 0.

			(function(scene,octree,cameraControls,material_entities,entities){
				var w=110, h=0.5, d=60, x=-2, y=-h/2, z=2.6;
				var geometry = new THREE.BoxGeometry(w,h,d);
				geometry.translate(0, h/2, 0);
				var material = new THREE.MeshLambertMaterial();
				var mesh = new THREE.Mesh(geometry, material);
				mesh.name = "deck0"; mesh.visible = false;
				mesh.position.set(x,y,z); scene.add( mesh );
			//	var geometry = new THREE.EdgesGeometry( geometry );
			//	var segments = new THREE.LineSegments( geometry, material );
			//	segments.name = "water path edges";
			//	segments.position.copy( mesh.position );
			//	octree.importThreeMesh( mesh );
				entities && entities.add( mesh );
				material_entities && material_entities.add(material);
			//	cameraControls.rigidObjects.push( mesh );
			//	return mesh;
			})( scene, octree, cameraControls, material_entities, entities );

			(function(scene,octree,cameraControls,material_entities,entities){
				var w=100, h=0.5, d=50, x=-2, y=-0, z=2.6;
				var geometry = new THREE.BoxGeometry(w,h,d);
				geometry.translate(0, h/2, 0);
				var material = new THREE.MeshLambertMaterial();
				var mesh = new THREE.Mesh(geometry, material);
				mesh.name = "deck0_floor"; mesh.visible = false;
				mesh.position.set(x,y,z); scene.add( mesh );
			//	var geometry = new THREE.EdgesGeometry( geometry );
			//	var segments = new THREE.LineSegments( geometry, material );
			//	segments.name = "water path edges";
			//	segments.position.copy( mesh.position );
			//	octree.importThreeMesh( mesh );
				entities && entities.add( mesh );
				material_entities && material_entities.add(material);
			//	cameraControls.rigidObjects.push( mesh );
			//	return mesh;
			})( scene, octree, cameraControls, material_entities, entities );

		</script>

		<!-- script src="/editor/src/ViewportTab.js"></script -->

		<script>
/*
		//	Water path.

			(function(scene,octree,cameraControls,material_entities,entities){
				var w=2.5, h=0.5, d=200, x=-85, y=-h/2, z=100;
				var geometry = new THREE.BoxGeometry(w,h,d);
				geometry.translate(0, h/2, 0);
				var material = new THREE.MeshLambertMaterial();
				var mesh = new THREE.Mesh(geometry, material);
				mesh.name = "water path"; mesh.visible = false;
				mesh.position.set(x,y,z); scene.add( mesh );
			//	var geometry = new THREE.EdgesGeometry( geometry );
			//	var segments = new THREE.LineSegments( geometry, material );
			//	segments.name = "water path edges";
			//	segments.position.copy( mesh.position );
			//	octree.importThreeMesh( mesh );
				entities && entities.add( mesh );
				material_entities && material_entities.add(material);
			//	cameraControls.rigidObjects.push( mesh );
			//	return mesh;
			})( scene, octree, cameraControls, material_entities, entities );
*/

		</script>


	</body>
</html>
