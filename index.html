<!DOCTYPE html>
<html lang="en">
	<head>

		<title>Editor (alpha 0.1.6.2)</title>

		<meta charset="utf-8">
		<meta name="generator" content="Three.js Editor">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<link rel="stylesheet" href="/css/joystick.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootbox-dialoges.css">
		<link rel="stylesheet" href="/css/jcrop.css">

		<script src="/js/watch.js"></script>
		<script src="/js/Objectid.js"></script>
		<script src="/js/jquery.min.js"></script> 
		<script src="/js/system.min.js"></script>
		<script src="/js/signals.min.js"></script>
		<script src="/js/inflate.min.js"></script>
		<script src="/js/zangodb.min.js"></script>
		<script src="/js/bootstrap.min.js"></script>
		<script src="/js/validator.min.js"></script>
		<script src="/js/hold-event.min.js"></script>
		<script src="/js/jcrop.js"></script>

		<style>

			body {
				margin: 0px;
				font-size: 13px;
				font-family: sans-serif;
				background-repeat: repeat;
				background-image: url("https://i.imgur.com/rnZZU0i.png") !important;
				overflow: hidden;
			}

			#loading-bar {
				width:100%;
				height:100%;
				top:0; left:0;
				position:fixed;
				display:flex;
				align-items:center;
				justify-content:center;
			}

			.middle > * {
				top:0; 
				left:0;
				right:0;
				bottom:0;
				margin:auto;
				position:absolute;
			}

			#joystick1 {
				right: calc(40px + 370px);
			}
			
			#jumpButton {
				right: calc(105px + 370px);
			}

			.btn-matcap,
			.btn-terrain {
				padding:0;
				float:left;
				width:55px;
				height:55px;
				border:1px solid;
				border-radius:4px;
				margin-right:4px;
				margin-bottom:4px;
				display:inline-block;
			}

			.btn-matcap + .btn-matcap,
			.btn-terrain + .btn-terrain {
				margin-right:4px;
			}

		</style>
	</head>

	<body ontouchstart="">

		<script src="/editor/js/TabUI.js"></script>

		<script>
			const debugMode = true;
			const Signal = signals.Signal;
			const RAD2DEG = 57.29577951308232;
			const DEG2RAD = 0.017453292519943295;
			document.body.appendChild( createSidePanel() );
		</script>

		<script src="/editor/js/three.js"></script>
		<script src="/editor/js/MeshWalk.js"></script>
		<script src="/editor/js/UVsDebug.js"></script>
		<script src="/editor/js/FBXLoader.js"></script>
		<script src="/editor/js/VirtualInput.js"></script>
		<script src="/editor/js/KeyboardState.js"></script>
		<script src="/editor/js/EditorControls.js"></script>
		<script src="/editor/js/camera-controls.js"></script>
		<script src="/editor/js/SubdivisionModifier.js"></script>
		<script src="/editor/js/three-pathfinding.umd.js"></script>

		<script src="/threejs/r96/examples/js/loaders/GLTFLoader.js"></script>
		<script src="/threejs/r96/examples/js/exporters/GLTFExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/STLExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/OBJExporter.js"></script>
		<script src="/threejs/r96/examples/js/exporters/ColladaExporter.js"></script>

	<!-- Water.js -->

		<script src="/editor/js/Ocean_fft.js"></script>
		<script src="/editor/js/MirrorRenderer.js"></script>
		<script src="/editor/js/WaterMaterial.js"></script>

	<!-- Engine.js -->

		<script src="/editor/core/helpers.js"></script>
		<script src="/editor/core/keyboard.js"></script>
		<script src="/editor/core/enviroment.js"></script>
		<script src="/editor/core/localPlayer.js"></script>
		<script src="/editor/core/cameraControls.js"></script>
		<script src="/editor/core/keyboardState.js"></script>
		<script src="/editor/core/keyInputControls.js"></script>
		<script src="/editor/core/joystickControls.js"></script>

	<!-- Editor.js -->

		<script src="/editor/src/EntityManager.js"></script>
		<script src="/editor/src/MaterialManager.js"></script>
		<script src="/editor/src/TexturesManager.js"></script>
		<script src="/editor/src/UndoArray.js"></script>
		<script src="/editor/src/imgru-db.js"></script>
		<script src="/editor/src/editor-meta.js"></script>

		<script src="/editor/src/editor-tab-ui.js"></script>
		<script src="/editor/src/geometry-tab-ui.js"></script>
		<script src="/editor/src/material-tab-ui.js"></script>
		<script src="/editor/src/textures-tab-ui.js"></script>
		<script src="/editor/src/skydome-tab-ui.js"></script>
		<script src="/editor/src/images-tab-ui.js"></script>

		<script src="/editor/src/watchers-call-ui.js"></script>
		<script src="/editor/src/entities-helpers.js"></script>
		<script src="/editor/src/TextureEditor.js"></script>
		<script src="/editor/src/MaterialEditor.js"></script>
		<script src="/editor/src/Object3DEditor.js"></script>
		<script src="/editor/src/RigidObjects.js"></script>
		<script src="/editor/src/editor-droplists.js"></script>
		<script src="/editor/src/edges-helper.js"></script>
		<script src="/editor/src/octree-helpers.js"></script>
		<script src="/editor/src/geometry-buttons.js"></script>
		<script src="/editor/src/geometry-inputs.js"></script>
		<script src="/editor/src/editor-buttons.js"></script>
		<script src="/editor/src/rigid-objects-buttons.js"></script>
		<script src="/editor/src/editor-key-inputs.js"></script>
		<script src="/editor/src/editor-mouse-inputs.js"></script>
		<script src="/editor/src/editor-manager.js"></script>
		<script src="/editor/src/editor-systems.js"></script>
		<script src="/editor/src/material-droplists.js"></script>
		<script src="/editor/src/material-manager.js"></script>
		<script src="/editor/src/material-buttons.js"></script>
		<script src="/editor/src/material-key-inputs.js"></script>
		<script src="/editor/src/material-mouse-inputs.js"></script>
		<script src="/editor/src/texture-droplists.js"></script>
		<script src="/editor/src/texture-manager.js"></script>
		<script src="/editor/src/texture-buttons.js"></script>
		<script src="/editor/src/texture-key-inputs.js"></script>
		<script src="/editor/src/texture-mouse-inputs.js"></script>
		<script src="/editor/src/texture-viewer.js"></script>
		<script src="/editor/src/editor-center-helper.js"></script>
		<script src="/editor/src/Water.js"></script>
		<script src="/editor/src/Skydome.js"></script>
		<script src="/editor/src/skydome-droplist.js"></script>
		<script src="/editor/src/background-droplist.js"></script>
		<script src="/editor/src/skydome-buttons.js"></script>
		<script src="/editor/src/images-inputs.js"></script>
		<script src="/editor/src/images-uploads.js"></script>

		<script>

			var materialdB; // debug!
/*
		//	materialdB.js

			const materialdB = new zango.Db( "material", [
				"rock","floor","wood","metal","fabric","bricks","matcap","plaster",
				"roofing","terrain","concrete","sandstone","environment","others",
				"materials", textures", "images" // meta.
			]);

			materialdB.open(function(err, database){
				if (err) console.error(err);
			}).then( function(){

				debugMode && console.log( 
					"Database " + materialdB.name 
					+ " (v" + materialdB.version 
					+ ") ready for use."
				);

			}).catch(function(err){
				console.error(err);
			});
*/
		</script>

		<script>

		//	create-new-material-tab-ui.js

			TabUI.add( "NewMaterial", "create-new-material-tab" ); TabUI.append( "NewMaterial" );
			TabUI.NewMaterial.pill.innerHTML = "New&nbsp;Material";

			(function( tab ){

			//	Materlals Collection droplist. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.textContent = "Collection:"; row.style.cssText = "height:30px;";
				var select = document.createElement("select"); select.id = "create-material-collection-droplist";
				select.style.cssText = "width:150px;color:#000;float:right;border:1px solid;border-radius:4px;";
				select.style.cssText += "font-size:20px;margin-left:10px;margin-right:15px;padding:2px 4px 4px 4px;";

				var keys =  "rock,floor,wood,metal,fabric,bricks,terrain,plaster,roofing,matcap,concrete,sandstone,environment,others";
				keys.split(",").forEach(function( name ){
					var option = document.createElement("option"); option.text = name; option.value = name; select.appendChild( option );
				}); watch( select, "onchange", function(prop, event, value){ console.log({item:select,event:event,value:value}); });
				select.addEventListener( "change", function(){ this.blur(); callWatchers( this, "onchange", "change", this.value ); });

				row.appendChild( select ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-type-droplist-ui.js

			(function( tab ){

			//	Create Material Type droplist. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.textContent = "type:"; row.style.cssText = "height:30px;margin-top:20px;display:none;";

				var select = document.createElement("select"); select.id = "material-type-droplist";
				select.style.cssText  = "width:210px;color:#000;float:right;border:1px solid;border-radius:4px;";
				select.style.cssText += "font-size:20px;margin-left:10px;margin-right:15px;padding:2px 4px 4px 4px;";

				var types = "MeshBasicMaterial,MeshStandardMaterial,MeshLambertMaterial,MeshPhongMaterial,";
				types += "MeshDepthMaterial,MeshNormalMaterial,MeshToonMaterial,MeshPhysicalMaterial,PointsMaterial,";
				types += "LineBasicMaterial,LineDashedMaterial,RawShaderMaterial,ShaderMaterial,ShadowMaterial,SpriteMaterial";
				types.split(",").forEach(function( name ){
					var option = document.createElement("option"); option.text = name; option.value = name; select.appendChild( option );
				}); select.value = "MeshStandardMaterial"; 
				watch( select, "onchange", function(prop, event, value){ console.log({item:select,event:event,value:value}); });
				select.addEventListener( "change", function(){ this.blur(); callWatchers( this, "onchange", "change", this.value ); });

				row.appendChild( select ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-viewer-ui.js

			(function( tab ){

			//	Create New Material viewer. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.style.cssText = "height:260px;border:none;text-align:center;margin-right:15px;";
				var canvas = document.createElement("canvas"); canvas.width = 256; canvas.height = 256; canvas.id = "create-new-material-viewer"; 
				canvas.style.cssText = "width:256px;height:256px;margin:auto;background-repeat:repeat;background-image:url('https://i.imgur.com/rnZZU0i.png') !important;";
				row.appendChild( canvas ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-name-input-ui.js

			(function( tab ){

			//	Create New Material Name input. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.style.cssText = "margin-right:15px;height:30px;";
				var input = document.createElement("input"); input.id = "create-new-material-name-input";
				input.setAttribute("placeholder", "name" ); input.classList.add("form-control","text-center");
				input.style.cssText = "width:-webkit-fill-available;color:#000;display:inline;margin:0px 5px;";
				input.style.cssText += "text-align:center;font-size:large;font-weigth:bold;background:none;";
				row.appendChild(input); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-button-ui.js

			(function( tab ){

			//	Create New Material button. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.style.cssText = "height:40px;margin-bottom:20px;";
				var btn = document.createElement("div"); btn.id = "create-new-material-button"; btn.textContent = "New Material";
				btn.classList.add( "form-control","btn", "btn-primary","btn-white-outline","gradient-btn" );
				btn.style.cssText = "width:-webkit-fill-available;height:40px;font-size:large;margin-right:15px;float:right;";
				row.appendChild( btn ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );


		//	create-new-material-bump-scale-ui.js

			(function( tab ){

			//	Create New Material Bump Scale input. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3");row.textContent = "bump:"; row.style.cssText = "height:30px;margin:20px 15px 20px 0;";
				var vect = document.createElement("div"); vect.style.cssText = "width:170px;height:40px;float:right;";
				var prev = document.createElement("li"); prev.innerHTML = "&#9668;"; prev.style.display = "inline";
				var next = document.createElement("li"); next.innerHTML = "&#9658;"; next.style.display = "inline";
				prev.id = "create-new-material-bump-decrease"; prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");
				next.id = "create-new-material-bump-increase"; next.classList.add("btn","btn-primary","get-next-btn","pull-right"); 

				var input = document.createElement("input"); input.id = "create-new-material-bump-input";
				input.setAttribute("placeholder", "scale" ); input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:80px;margin:0px 5px;text-align:center;font-size:large;font-weigth:bold;background:none;";
				vect.appendChild(prev); vect.appendChild(input); vect.appendChild(next); row.appendChild(vect); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-normal-scale-ui.js

			(function( tab ){

			//	Create New Material Normal Scale input. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3");row.textContent = "normal:"; row.style.cssText = "height:30px;margin:20px 15px 20px 0;";
				var vect = document.createElement("div"); vect.style.cssText = "width:170px;height:40px;float:right;";
				var prev = document.createElement("li"); prev.innerHTML = "&#9668;"; prev.style.display = "inline";
				var next = document.createElement("li"); next.innerHTML = "&#9658;"; next.style.display = "inline";
				prev.id = "create-new-material-normal-decrease"; prev.classList.add("btn","btn-primary","get-prev-btn","pull-left");
				next.id = "create-new-material-normal-increase"; next.classList.add("btn","btn-primary","get-next-btn","pull-right"); 

				var input = document.createElement("input"); input.id = "create-new-material-normal-input";
				input.setAttribute("placeholder", "scale" ); input.classList.add("form-control","text-center");
				input.style.cssText = "color:#000;border:none;display:inline;width:80px;margin:0px 5px;text-align:center;font-size:large;font-weigth:bold;background:none;";
				vect.appendChild(prev); vect.appendChild(input); vect.appendChild(next); row.appendChild(vect); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-map-droplist-ui.js

			(function( tab ){

			//	Create New Material Texture droplist. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.textContent = "select:"; row.style.cssText = "height:30px;";
				var select = document.createElement("select"); select.id = "create-new-material-map-droplist";
				select.style.cssText  = "width:170px;color:#000;float:right;border:1px solid;border-radius:4px;";
				select.style.cssText += "font-size:20px;margin-left:0px;margin-right:15px;padding:2px 4px 4px 4px;";

				var keys =  [
					{name:"Diffuse",value:"map"},
					{name:"Bump",value:"bumpMap"},
					{name:"Alpha",value:"alphaMap"},
					{name:"Light",value:"lightMap"},
					{name:"Normal",value:"normalMap"},
					{name:"Specular",value:"specularMap"},
					{name:"Emissive",value:"emissiveMap"},
					{name:"Metalness",value:"metalnessMap"},
					{name:"Roughness",value:"roughnessMap"},
					{name:"Environment",value:"envMap"},
					{name:"Displacement",value:"displacementMap"},
					{name:"Ambient/Occlusion",value:"aoMap"}
				];

				keys.forEach(function( key ){
					var option = document.createElement("option"); option.text = key.name; option.value = key.value; select.appendChild( option );
				}); select.value = "map";
				watch( select, "onchange", function(prop, event, value){ console.log({item:select,event:event,value:value}); });
				select.addEventListener( "change", function(){ this.blur(); callWatchers( this, "onchange", "change", this.value ); });

				row.appendChild( select ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-image-button-ui.js

			(function( tab ){

			//	Create New Material Image button. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.style.cssText = "height:40px;margin-bottom:20px;margin-right:15px;";

				var icon = document.createElement("canvas"); icon.id = "create-new-material-icon";
				icon.width = icon.height = 36; icon.style.cssText = "border:thin solid #888888;border-radius:4px;float:left;";

				var btn = document.createElement("div"); btn.id = "create-new-material-img-button"; 
				btn.classList.add( "form-control","btn", "btn-primary","btn-white-outline","gradient-btn" );
				btn.textContent = "Import Image"; btn.style.cssText = "width:220px;float:right;height:40px;font-size:large;";

				var input = document.createElement("input"); input.type = "file"; 
				input.id = "create-new-material-file-input"; input.style.cssText = "display:none;"; 
				btn.appendChild( input ); row.appendChild( icon ); row.appendChild( btn ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

			//	var img = new Image(40,40); img.style.cssText = "border-radius:4px;float:left;";
			//	watch( img, "onload", function(prop, event, value){ console.log({item:img,event:event,src:value}); });
			//	img.addEventListener("load",function(event){ callWatchers( this, "onload", "load", this.src ); });
			//	img.addEventListener("error",function(){ this.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; });

		//	create-new-material-save-button-ui.js

			(function( tab ){

			//	Create New Material Save button. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.style.cssText = "height:30px;margin-bottom:20px;";
				var btn = document.createElement("div"); btn.id = "create-new-material-save-button"; btn.textContent = "Save Material";
				btn.classList.add( "form-control","btn", "btn-primary","btn-white-outline","gradient-btn" );
				btn.style.cssText = "width:-webkit-fill-available;height:40px;font-size:large;margin-right:15px;float:right;";
				row.appendChild( btn ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-apply-button-ui.js

			(function( tab ){

			//	Create New Material Apply button. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.style.cssText = "height:30px;margin-bottom:20px;";
				var btn = document.createElement("div"); btn.id = "create-new-material-apply-button"; btn.textContent = "Apply Material";
				btn.classList.add( "form-control","btn", "btn-primary","btn-white-outline","gradient-btn" );
				btn.style.cssText = "width:-webkit-fill-available;height:40px;font-size:large;margin-right:15px;float:right;";
				row.appendChild( btn ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		//	create-new-material-remove-button-ui.js

			(function( tab ){

			//	Create New Material Remove button. // var tab = TabUI.NewMaterial.tab;
				var row = document.createElement("h3"); row.style.cssText = "height:30px;margin-bottom:20px;";
				var btn = document.createElement("div"); btn.id = "create-new-material-remove-button"; btn.textContent = "Remove Texture";
				btn.classList.add( "form-control","btn", "btn-primary","btn-white-outline","gradient-btn" );
				btn.style.cssText = "width:-webkit-fill-available;height:40px;font-size:large;margin-right:15px;float:right;";
				row.appendChild( btn ); tab.appendChild( row );

			})( TabUI.NewMaterial.tab );

		</script>

		<script>

		//	create-new-material-viewer.js

			const materialViewer = {

				canvas: TabUI.NewMaterial.tab.querySelector("canvas#create-new-material-viewer"),

			};

		//	New Material Viewer scene.

			(function( materialViewer ){

				var interval;

			//	Viewer scene.

				materialViewer.scene = (function(){
					var scene = new THREE.Scene();
					scene.name = "material scene";
					return scene;
				})();

			//	Viewer camera.

				materialViewer.camera = (function( d ){
				//	var aspect = canvas.clientWidth / canvas.clientWidth;
					var camera = new THREE.OrthographicCamera( -d, +d, +d, -d, 1, 100 );
					camera.name = "camera"; camera.position.z = 10; camera.lookAt( 0,0,0 ); 
					materialViewer.scene.add( camera ); return camera;
				})( 1.2 );

			//	Viewer light.

				materialViewer.light = (function(){
					var light = new THREE.DirectionalLight( 0xffffff, 1 ); 
					light.name = "light"; light.position.set( 0,30,50 ); 
					materialViewer.scene.add( light ); return light;
				})();

			//  Viewr Renderer.

				materialViewer.renderer = new THREE.WebGLRenderer({
					alpha: true,  // for transparent rendering set alpha:true, important!
					canvas: materialViewer.canvas,
					antialias: true,
					preserveDrawingBuffer: true,
				});

				materialViewer.renderer.gammaInput = true;
				materialViewer.renderer.gammaOutput = true;
				materialViewer.renderer.shadowMap.enabled = true;
				materialViewer.renderer.setClearAlpha( 0 ); // for transparent rendering set clear alpha: 0.
				materialViewer.renderer.setClearColor( 0x000000, 0 ); // for transparent rendering set clear alpha: 0.
				materialViewer.renderer.setPixelRatio( window.devicePixelRatio );
				materialViewer.renderer.setSize( materialViewer.canvas.width, materialViewer.canvas.height );
				materialViewer.renderer.domElement.style.background = "none";  // transparent rendering. important!

			//	Viewer mesh.

				materialViewer.mesh = (function(){
					var mesh = new THREE.Mesh(
						new THREE.SphereGeometry(1,64,32), new THREE.MeshStandardMaterial()
					); mesh.material.bumpScale = 0.01; mesh.material.normalScale.set(1,1); 
					mesh.material.displacementBias = 0, mesh.material.displacementScale = 0;
					mesh.material.name = "new material"; mesh.name = "material viewer mesh"; 
					materialViewer.scene.add( mesh ); return mesh;
				})();

			//	Viewer render.

				materialViewer.render = function(){ materialViewer.mesh.material.needsUpdate = true; 
					materialViewer.renderer.render( materialViewer.scene, materialViewer.camera ); 
				};

			//	Viewer dispose.

				materialViewer.dispose = function(){

				//	dispose textures.

					(function( material ){
						material && material.map && material.map.dispose && material.map.dispose();
						material && material.bumpMap && material.bumpMap.dispose && material.bumpMap.dispose();
						material && material.alphaMap && material.alphaMap.dispose && material.alphaMap.dispose();
						material && material.normalMap && material.normalMap.dispose && material.normalMap.dispose();
						material && material.emissiveMap && material.emissiveMap.dispose && material.emissiveMap.dispose();
						material && material.roughnessMap && material.roughnessMap.dispose && material.roughnessMap.dispose();
						material && material.metalnessMap && material.metalnessMap.dispose && material.metalnessMap.dispose();
						material && material.displacementMap && material.displacementMap.dispose && material.displacementMap.dispose();
						material && material.lightMap && material.lightMap.dispose && material.lightMap.dispose();
						material && material.envMap && material.envMap.dispose && material.envMap.dispose();
						material && material.aoMap && material.aoMap.dispose && material.aoMap.dispose();
					})( materialViewer.mesh.material );

				//	remove textures.

					materialViewer.mesh.material.map = null;
					materialViewer.mesh.material.bumpMap = null;
					materialViewer.mesh.material.alphaMap = null;
					materialViewer.mesh.material.normalMap = null;
					materialViewer.mesh.material.emissiveMap = null;
					materialViewer.mesh.material.roughnessMap = null;
					materialViewer.mesh.material.metalnessMap = null;
					materialViewer.mesh.material.displacementMap = null;
					materialViewer.mesh.material.lightMap = null;
					materialViewer.mesh.material.envMap = null;
					materialViewer.mesh.material.aoMap = null;

				//	render.
				//	setTimeout( materialViewer.render ); // important!

				}

			//	Viewer Mesh Material render.
				watch( materialViewer.mesh, "material", function(prop, action, value){ 
					clearTimeout( interval ); interval = setTimeout(materialViewer.render, 50);
					debugMode && console.log({item:prop,action:action,value:value}); // debug.
				}, 0);

			//	Viewer render.
				materialViewer.render();

			})( materialViewer );

		</script>

		<script>

		//	create-new-material-button.js

			(function(viewer,button,input){

				var interval, k=0;

			//	Creates new material, and replaces material viewer material.
				watch( button, "onclick", function(prop, event, material){ 
					viewer.dispose(); viewer.mesh.material = material; input.value = material.name;
				//	viewer.mesh.material.copy(material); viewer.material.uuid = material.uuid;
					debugMode && console.log({item:button,event:event,material:material}); // debug.
				});

				button.addEventListener( "click", function(){
					clearTimeout(interval); interval = setTimeout(function(button){
						callWatchers(button, "onclick", "click", new THREE.MeshStandardMaterial({ 
							name:"untitled material " + (++k), normalScale:new THREE.Vector2(1,1),
							bumpScale:0.01, displacementBias:0, displacementScale:0 })
						);
					}, 250, this);
				})

			})( materialViewer, 
				TabUI.NewMaterial.tab.querySelector("div#create-new-material-button"), // button,
				TabUI.NewMaterial.tab.querySelector("input#create-new-material-name-input") // input,
			);

		//	create-new-material-image-input.js

			(function(viewer,icon,image_button,image_input,map_droplist){

				watch( image_button, "onclick", function(prop, event, value){ image_input.value = ""; image_input.click(); });
				watch( map_droplist, "onchange", function(prop, event, value){ image_input.value = ""; image_input.click(); });

				image_input.addEventListener( "change", function(){

					if ( !map_droplist.value ) return;
					if ( !image_input.files.length ) return;

					var file = image_input.files[0];

					var img = new Image();
					img.addEventListener("load", function(){

						var key = map_droplist.value; if ( !key ) return;

					//	draw icon.
						icon.getContext( "2d" ).drawImage( img, 0, 0, icon.width, icon.height );

					//	make power of two.
					//	var canvas = document.createElement("canvas");
					//	canvas.width = THREE.Math.floorPowerOfTwo( img.width );
					//	canvas.height = THREE.Math.floorPowerOfTwo( img.height );
					//	var context = canvas.getContext( "2d" );
					//	context.drawImage( img, 0, 0, canvas.width, canvas.height );

					//	create texture.
						var texture = new THREE.Texture(img); // or canvas.
						texture.name = file.name.replace(".jpg","").replace(".png","");
						texture.sourceFile = file.name; viewer.mesh.material[key] = texture; 
						viewer.mesh.material[key].needsUpdate = viewer.mesh.material.needsUpdate = true;

					//	render material. // important!
						callWatchers( viewer.mesh, "material", "set", viewer.mesh.material );
					});

					var reader = new FileReader();
					reader.addEventListener("load", function() {
						img.name = file.name;
						img.src = reader.result;
					});

					reader.readAsDataURL(file);
				});

				image_button.addEventListener( "click", function(){ callWatchers( image_button, "onclick", "click"); });

			})( materialViewer, 
				TabUI.NewMaterial.tab.querySelector("canvas#create-new-material-icon"), // icon,
				TabUI.NewMaterial.tab.querySelector("div#create-new-material-img-button"), // image_button,
				TabUI.NewMaterial.tab.querySelector("input#create-new-material-file-input"), // image_input,
				TabUI.NewMaterial.tab.querySelector("select#create-new-material-map-droplist") // map_droplist,
			);

		</script>

		<script>

		//	create-new-material-save-button.js

			(function(viewer,save_button,map_droplist){

				var interval;

				//	var mesh = viewer.mesh; var material = viewer.mesh.material;
				//	var meta = {geometries:{},materials:{},textures:{},images:{}};
				//	var json = viewer.mesh.toJSON(meta); debugMode && console.log(meta);

				watch(save_button, "onclick", function(prop, event, material){
					debugMode && console.log({item:save_button, event:event; material:material});

					var meta = {geometries:{},materials:{},textures:{},images:{}};
					var json = viewer.mesh.toJSON(meta); debugMode && console.log(meta);

				//	make power of two and convert image/png; 
				//	dataURL to data:image/jpeg;base64 dataURL.

					for ( var uuid in meta.images ) {
						(function(data){
							var img = new Image(); img.src = data.url; 
							var canvas = document.createElement("canvas");
							canvas.width = THREE.Math.floorPowerOfTwo( img.width );
							canvas.height = THREE.Math.floorPowerOfTwo( img.height );
							canvas.getContext("2d").drawImage( img, 0, 0, canvas.width, canvas.height );
							data.url = canvas.toDataURL("image/jpeg");
						}){meta.images[uuid]};
					} 

					debugMode && console.log(meta);


					save_button.addEventListener( "click", onSaveButtonClick ); // important!

				});

			//	Parse viewer mesh json meta data to watcher.
				save_button.addEventListener( "click", onSaveButtonClick );

				function onSaveButtonClick(){
					clearTimeout( interval ); 
					interval = setTimeout( function(button){ 
						callWatchers( button, "onclick", "save", meta ); 
						button.removeEventListener( "click", onSaveButtonClick );
					}, 250, this);
				});

			})( materialViewer, 
				TabUI.NewMaterial.tab.querySelector("div#create-new-material-save-button"), // save_button,
				TabUI.NewMaterial.tab.querySelector("select#create-new-material-map-droplist") // map_droplist,
			);

		</script>

		<script>

			TabUI.NewMaterial.role.classList.add("active");
			TabUI.NewMaterial.tab.classList.add("in","active");

		//	scene.add(ground);
		//	mirror.visible = !mirror.visible; 
		//	ground.visible = !ground.visible; 
			groundHelper.visible = !groundHelper.visible; 


		//	Add entities.
		//	entities.add(scene);
		//	entities.add(mirror);
		//	entities.add(ground);
		//	entities.add(localPlayer);
			entities.add(groundHelper);
			entities.add(localPlayer.getObjectByName("local helper"));

			cameraControls.setLatLon(5.128, 270.675);
			localPlayer.controller.movementSpeed = 20;
			localPlayer.controller.center.set(-85,2,-2);
			localPlayer.visible = !localPlayer.visible; 

		</script>

		<script src="/editor/src/database-tab-ui.js"></script>
		<script src="/editor/src/database-inputs.js"></script>
	<!-- script src="/editor/src/ViewportTab.js"></script -->
		<script src="/editor/src/playground.js"></script>

	</body>
</html>
